apiVersion: 1

groups:
  - orgId: 1
    name: Error Detection
    folder: Alerting
    interval: 1m
    rules:
      # High error rate across all services
      - uid: high-error-rate
        title: High Error Rate (Global)
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: loki
            model:
              expr: 'sum(count_over_time({project=~".+"} |~ "(?i)(error|exception|fatal)" [5m]))'
              queryType: instant
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 20
                  operator:
                    type: and
                  reducer:
                    type: last
        noDataState: OK
        execErrState: Error
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High error rate detected across services"
          description: "More than 20 errors in the last 5 minutes"

      # WordPress PHP Errors
      - uid: wordpress-php-errors
        title: WordPress PHP Errors
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: loki
            model:
              expr: 'sum(count_over_time({project=~"abemon.es|BM Consulting"} |~ "PHP (Fatal|Parse error|Warning|Notice)" [5m]))'
              queryType: instant
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 5
                  operator:
                    type: and
                  reducer:
                    type: last
        noDataState: OK
        execErrState: Error
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "PHP errors detected in WordPress sites"
          description: "Check abemon.es and bm.consulting for PHP errors"

      # Database Connection Errors
      - uid: database-errors
        title: Database Connection Errors
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: loki
            model:
              expr: 'sum(count_over_time({service_name=~"MySQL|Postgres.*"} |~ "(?i)(connection refused|timeout|deadlock|too many connections)" [5m]))'
              queryType: instant
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 3
                  operator:
                    type: and
                  reducer:
                    type: last
        noDataState: OK
        execErrState: Error
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Database connection errors detected"
          description: "MySQL or PostgreSQL connectivity issues"

      # API Errors (500 responses)
      - uid: api-500-errors
        title: API 500 Errors
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: loki
            model:
              expr: 'sum(count_over_time({project=~"foodplan.pro|api-pricing"} |~ "(?i)(500|internal server error|unhandled)" [5m]))'
              queryType: instant
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 5
                  operator:
                    type: and
                  reducer:
                    type: last
        noDataState: OK
        execErrState: Error
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "API returning 500 errors"
          description: "Critical errors in API services"

      # Memory/Resource Issues
      - uid: memory-issues
        title: Memory or Resource Issues
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: loki
            model:
              expr: 'sum(count_over_time({project=~".+"} |~ "(?i)(out of memory|memory limit|killed|OOM)" [10m]))'
              queryType: instant
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 1
                  operator:
                    type: and
                  reducer:
                    type: last
        noDataState: OK
        execErrState: Error
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Memory or resource exhaustion detected"
          description: "A service may be running out of memory"

  - orgId: 1
    name: Service Health
    folder: Alerting
    interval: 2m
    rules:
      # No logs from critical services
      - uid: service-silent
        title: Service Not Logging
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 900
              to: 0
            datasourceUid: loki
            model:
              expr: 'sum(count_over_time({project="abemon.es"} [15m]))'
              queryType: instant
          - refId: B
            relativeTimeRange:
              from: 900
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: lt
                    params:
                      - 1
                  operator:
                    type: and
                  reducer:
                    type: last
        noDataState: Alerting
        execErrState: Error
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "abemon.es has no logs in 15 minutes"
          description: "Service may be down or not generating logs"

      # Deployment failures
      - uid: deploy-failures
        title: Deployment Failures
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: loki
            model:
              expr: 'sum(count_over_time({project=~".+"} |~ "(?i)(deploy failed|deployment crashed|build failed|exit code 1)" [10m]))'
              queryType: instant
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 0
                  operator:
                    type: and
                  reducer:
                    type: last
        noDataState: OK
        execErrState: Error
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Deployment failure detected"
          description: "A service deployment may have failed"

  # Resource Metrics alerts using Prometheus data from railway-exporter
  - orgId: 1
    name: Resource Metrics
    folder: Alerting
    interval: 1m
    rules:
      # CPU High Usage Warning (70%)
      - uid: cpu-high-warning
        title: CPU Usage High (Warning)
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: 'railway_service_cpu_utilization > 0.7'
              instant: true
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 0
                  operator:
                    type: and
                  reducer:
                    type: last
        noDataState: OK
        execErrState: Error
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage on {{ $labels.service_name }}"
          description: "CPU utilization above 70% for {{ $labels.service_name }} in {{ $labels.project_name }}"

      # CPU Critical (90%)
      - uid: cpu-critical
        title: CPU Usage Critical
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: 'railway_service_cpu_utilization > 0.9'
              instant: true
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 0
                  operator:
                    type: and
                  reducer:
                    type: last
        noDataState: OK
        execErrState: Error
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Critical CPU usage on {{ $labels.service_name }}"
          description: "CPU utilization above 90% - service may be overloaded"

      # Memory High Warning (80%)
      - uid: memory-high-warning
        title: Memory Usage High (Warning)
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: 'railway_service_memory_utilization > 0.8'
              instant: true
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 0
                  operator:
                    type: and
                  reducer:
                    type: last
        noDataState: OK
        execErrState: Error
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage on {{ $labels.service_name }}"
          description: "Memory utilization above 80% for {{ $labels.service_name }}"

      # Memory Critical (95%)
      - uid: memory-critical
        title: Memory Usage Critical
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: 'railway_service_memory_utilization > 0.95'
              instant: true
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 0
                  operator:
                    type: and
                  reducer:
                    type: last
        noDataState: OK
        execErrState: Error
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Critical memory usage on {{ $labels.service_name }}"
          description: "Memory utilization above 95% - risk of OOM"

      # Service Down (not reporting metrics)
      - uid: service-down
        title: Service Not Reporting Metrics
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: 'railway_service_up == 0'
              instant: true
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 0
                  operator:
                    type: and
                  reducer:
                    type: last
        noDataState: OK
        execErrState: Error
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Service {{ $labels.service_name }} is down"
          description: "Service not running in project {{ $labels.project_name }}"

  # Asterisk Security Alerts
  - orgId: 1
    name: Asterisk Security
    folder: Alerting
    interval: 1m
    rules:
      # Brute Force Attack Detection
      - uid: asterisk-brute-force
        title: Asterisk Brute Force Attack
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: loki
            model:
              expr: 'sum(count_over_time({service_name="asterisk"} |~ "(?i)(auth.*fail|authentication.*failed|wrong.*password|invalid.*credentials)" [5m]))'
              queryType: instant
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 10
                  operator:
                    type: and
                  reducer:
                    type: last
        noDataState: OK
        execErrState: Error
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Possible brute force attack on Asterisk"
          description: "More than 10 authentication failures in 5 minutes - potential SIP brute force attack"

      # Invalid Auth Warning
      - uid: asterisk-auth-warning
        title: Asterisk Auth Failures
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: loki
            model:
              expr: 'sum(count_over_time({service_name="asterisk"} |~ "(?i)(SECURITY|Unauthorized|Invalid|Rejected)" [10m]))'
              queryType: instant
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 5
                  operator:
                    type: and
                  reducer:
                    type: last
        noDataState: OK
        execErrState: Error
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Security events detected on Asterisk"
          description: "More than 5 security-related events in 10 minutes"

      # Rate Limiting Active
      - uid: asterisk-rate-limiting
        title: Asterisk Rate Limiting Active
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: loki
            model:
              expr: 'sum(count_over_time({service_name="asterisk"} |~ "(?i)(rate.*limit|throttl|flood|hashlimit)" [5m]))'
              queryType: instant
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 0
                  operator:
                    type: and
                  reducer:
                    type: last
        noDataState: OK
        execErrState: Error
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "Rate limiting active on Asterisk"
          description: "SIP traffic is being rate limited - possible flood attack"

      # Unauthorized DID Attempts
      - uid: asterisk-unauthorized-did
        title: Unauthorized DID Access Attempt
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: loki
            model:
              expr: 'sum(count_over_time({service_name="asterisk"} |~ "Unauthorized DID" [5m]))'
              queryType: instant
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 0
                  operator:
                    type: and
                  reducer:
                    type: last
        noDataState: OK
        execErrState: Error
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "Unauthorized DID access attempt"
          description: "Someone attempted to call using an unauthorized DID - possible toll fraud attempt"
