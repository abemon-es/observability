# Vector Configuration for abemon.es Observability
# Receives logs from Railway log drains and ships to Loki

# Health check API
[api]
enabled = true
address = "0.0.0.0:8686"
playground = false

# ============================================
# SOURCES - Railway Log Drain HTTP endpoint
# ============================================

[sources.railway_logs]
type = "http_server"
address = "0.0.0.0:8080"
decoding.codec = "json"

# Internal Vector metrics
[sources.vector_metrics]
type = "internal_metrics"

# ============================================
# TRANSFORMS - Process and enrich logs
# ============================================

[transforms.parse_railway]
type = "remap"
inputs = ["railway_logs"]
source = '''
.service = .service_name ?? .serviceName ?? .service ?? "unknown"
.environment = .environment ?? "production"
.project = .project_name ?? .projectName ?? .project ?? "unknown"
.timestamp = .timestamp ?? now()
.msg = .message ?? .msg ?? .log ?? to_string(.)
.level = .level ?? .severity ?? "info"

if contains(to_string(.msg) ?? "", "error") || contains(to_string(.msg) ?? "", "ERROR") {
  .level = "error"
} else if contains(to_string(.msg) ?? "", "warn") || contains(to_string(.msg) ?? "", "WARN") {
  .level = "warn"
}

.source = "railway"
'''

# ============================================
# SINKS - Send to Loki
# ============================================

[sinks.loki]
type = "loki"
inputs = ["parse_railway"]
endpoint = "${LOKI_URL}"
encoding.codec = "json"

[sinks.loki.labels]
service = "{{ service }}"
environment = "{{ environment }}"
level = "{{ level }}"
source = "{{ source }}"

# Debug output
[sinks.console]
type = "console"
inputs = ["parse_railway"]
encoding.codec = "text"
