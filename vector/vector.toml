# Vector Configuration for abemon.es Observability
# Receives logs from Railway log drains and ships to Loki

[api]
enabled = true
address = "0.0.0.0:8686"

# ============================================
# SOURCES - Railway Log Drain HTTP endpoint
# ============================================

[sources.railway_logs]
type = "http_server"
address = "0.0.0.0:8080"
encoding = "json"
headers = ["X-Railway-Service", "X-Railway-Environment", "X-Railway-Project"]

# Internal Vector metrics
[sources.vector_metrics]
type = "internal_metrics"

# ============================================
# TRANSFORMS - Process and enrich logs
# ============================================

[transforms.parse_railway]
type = "remap"
inputs = ["railway_logs"]
source = '''
# Extract service name from header or message
.service = get!(., ["X-Railway-Service"]) ?? "unknown"
.environment = get!(., ["X-Railway-Environment"]) ?? "production"
.project = get!(., ["X-Railway-Project"]) ?? "unknown"

# Ensure timestamp exists
.timestamp = .timestamp ?? now()

# Try to parse JSON message if present
if exists(.message) {
  parsed, err = parse_json(.message)
  if err == null {
    .level = parsed.level ?? "info"
    .msg = parsed.msg ?? parsed.message ?? .message
  } else {
    .level = "info"
    .msg = .message
  }
}

# Detect log level from message content
if contains(string!(.msg), "error") || contains(string!(.msg), "Error") || contains(string!(.msg), "ERROR") {
  .level = "error"
} else if contains(string!(.msg), "warn") || contains(string!(.msg), "Warn") || contains(string!(.msg), "WARN") {
  .level = "warn"
}

# Add source label
.source = "railway"
'''

# Filter out health checks and noise
[transforms.filter_noise]
type = "filter"
inputs = ["parse_railway"]
condition = '''
!starts_with(string!(.msg), "GET /health") &&
!starts_with(string!(.msg), "GET /favicon") &&
!starts_with(string!(.msg), "HEAD /")
'''

# ============================================
# SINKS - Send to Loki
# ============================================

[sinks.loki]
type = "loki"
inputs = ["filter_noise"]
endpoint = "${LOKI_URL}"
encoding.codec = "json"

[sinks.loki.labels]
service = "{{ service }}"
environment = "{{ environment }}"
project = "{{ project }}"
level = "{{ level }}"
source = "{{ source }}"

# Console output for debugging
[sinks.console]
type = "console"
inputs = ["filter_noise"]
encoding.codec = "text"
