# Vector Configuration for abemon.es Observability
# Receives logs from Railway log drains and ships to Loki

# ============================================
# SOURCES - Railway Log Drain HTTP endpoint
# ============================================

# HTTP server to receive logs (uses PORT env var from Railway)
[sources.railway_logs]
type = "http_server"
address = "0.0.0.0:8080"
decoding.codec = "json"
strict_path = false

# Internal Vector metrics
[sources.vector_metrics]
type = "internal_metrics"

# ============================================
# TRANSFORMS - Process and enrich logs
# ============================================

[transforms.parse_railway]
type = "remap"
inputs = ["railway_logs"]
source = '''
.service = .service_name ?? .serviceName ?? .service ?? "unknown"
.environment = .environment ?? "production"
.project = .project_name ?? .projectName ?? .project ?? "unknown"
.timestamp = .timestamp ?? now()
.msg = .message ?? .msg ?? .log ?? encode_json(.)
.level = .level ?? .severity ?? "info"
.source = "railway"
'''

# ============================================
# SINKS - Send to Loki
# ============================================

[sinks.loki]
type = "loki"
inputs = ["parse_railway"]
endpoint = "${LOKI_URL:-http://localhost:3100}"
encoding.codec = "json"

[sinks.loki.labels]
service = "{{ service }}"
environment = "{{ environment }}"
level = "{{ level }}"
source = "{{ source }}"

# Debug output
[sinks.console]
type = "console"
inputs = ["parse_railway"]
encoding.codec = "json"
